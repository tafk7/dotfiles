#!/bin/bash
# Uninstall tools installed by the dotfiles system
# Usage: uninstall-tool <name>    Remove a tool
#        uninstall-tool --list    Show installed tools

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib.sh"

# Tool registry: name -> paths to remove (space-separated)
# "manual" means the tool has its own removal process
declare -A TOOL_REGISTRY=(
    [starship]="$HOME/.local/bin/starship"
    [eza]="$HOME/.local/bin/eza"
    [zoxide]="$HOME/.local/bin/zoxide"
    [delta]="$HOME/.local/bin/delta"
    [btop]="$HOME/.local/bin/btop"
    [neovim]="$HOME/.local/bin/nvim $HOME/.local/nvim"
    [lazygit]="$HOME/.local/bin/lazygit"
    [uv]="$HOME/.local/bin/uv $HOME/.local/bin/uvx"
    [poetry]="$HOME/.local/bin/poetry"
    [nvm]="manual"
    [pyenv]="manual"
)

# Instructions for manually-managed tools
declare -A MANUAL_INSTRUCTIONS=(
    [nvm]="rm -rf \$HOME/.nvm  # then remove NVM lines from shell config"
    [pyenv]="rm -rf \$HOME/.pyenv  # then remove pyenv lines from shell config"
)

show_usage() {
    echo "Usage: uninstall-tool <name>"
    echo "       uninstall-tool --list"
    echo ""
    echo "Remove tools installed by the dotfiles system."
}

list_tools() {
    echo "Tool              Status        Location"
    echo "────────────────  ────────────  ────────────────────────────────"

    # Sort tool names
    local names
    readarray -t names < <(printf '%s\n' "${!TOOL_REGISTRY[@]}" | sort)

    for name in "${names[@]}"; do
        local paths="${TOOL_REGISTRY[$name]}"

        if [[ "$paths" == "manual" ]]; then
            # Check if the tool command exists
            local cmd="$name"
            [[ "$name" == "nvm" ]] && cmd="nvm"
            [[ "$name" == "pyenv" ]] && cmd="pyenv"

            if [[ -d "$HOME/.${name}" ]]; then
                printf "%-18s%-14s%s\n" "$name" "installed" "~/.${name}/ (self-managed)"
            else
                printf "%-18s%-14s%s\n" "$name" "not found" ""
            fi
            continue
        fi

        # Check if any of the tool's paths exist
        local first_path found=false
        for path in $paths; do
            if [[ -e "$path" ]]; then
                found=true
                first_path="$path"
                break
            fi
        done

        if [[ "$found" == true ]]; then
            local display_path="${first_path/#$HOME/~}"
            printf "%-18s%-14s%s\n" "$name" "installed" "$display_path"
        else
            printf "%-18s%-14s%s\n" "$name" "not found" ""
        fi
    done
}

uninstall_tool() {
    local name="$1"

    if [[ -z "${TOOL_REGISTRY[$name]+x}" ]]; then
        error "Unknown tool: $name"
        echo ""
        echo "Known tools:"
        printf '  %s\n' "${!TOOL_REGISTRY[@]}" | sort
        exit 1
    fi

    local paths="${TOOL_REGISTRY[$name]}"

    if [[ "$paths" == "manual" ]]; then
        warn "$name is self-managed. Remove manually:"
        echo "  ${MANUAL_INSTRUCTIONS[$name]}"
        exit 0
    fi

    local removed=false
    for path in $paths; do
        if [[ -e "$path" ]]; then
            rm -rf "$path"
            log "Removed: $path"
            removed=true
        fi
    done

    if [[ "$removed" == true ]]; then
        success "$name uninstalled"
    else
        warn "$name was not installed (nothing to remove)"
    fi
}

# Main
if [[ $# -eq 0 ]]; then
    show_usage
    exit 1
fi

case "$1" in
    --list|-l)
        list_tools
        ;;
    --help|-h)
        show_usage
        ;;
    *)
        uninstall_tool "$1"
        ;;
esac
