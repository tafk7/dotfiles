#!/bin/bash

# Switch between different tmux configurations

set -euo pipefail

# Source common functions
source "${DOTFILES_DIR:-$HOME/dotfiles}/lib.sh"

# Function to show usage
show_usage() {
    echo "Usage: $0 [minimal|full]"
    echo ""
    echo "Switch between tmux configurations:"
    echo "  minimal - Lightweight config (no plugins, no TPM, hardcoded status bar)"
    echo "  full    - Full-featured config with TPM and plugins"
    echo ""
    local current_target
    current_target=$(readlink ~/.tmux.conf 2>/dev/null || echo "Unknown")
    if [[ "$current_target" == *"minimal"* ]]; then
        echo "Current config: minimal"
    elif [[ "$current_target" == *"tmux.conf" ]]; then
        echo "Current config: full"
    else
        echo "Current config: Unknown ($current_target)"
    fi
    echo ""
    echo "Tip: Use minimal config on remote servers, full config for local development"
}

# Get the configuration choice
CONFIG="${1:-}"

if [[ -z "$CONFIG" ]]; then
    show_usage
    exit 0
fi

case "$CONFIG" in
    minimal)
        log "Switching to minimal tmux configuration..."
        ln -sf "$DOTFILES_DIR/configs/tmux.conf.minimal" ~/.tmux.conf
        success "Switched to minimal configuration (no plugins, fast startup)"
        ;;
    full)
        log "Switching to full tmux configuration..."
        ln -sf "$DOTFILES_DIR/configs/tmux.conf" ~/.tmux.conf
        success "Switched to full configuration (TPM + plugins)"
        ;;
    *)
        error "Unknown configuration: $CONFIG"
        show_usage
        exit 1
        ;;
esac

# Store preference
mkdir -p ~/.config/tmux
echo "$CONFIG" > ~/.config/tmux/.tmux-mode

# Auto-reload tmux if running
if tmux info >/dev/null 2>&1; then
    tmux source-file ~/.tmux.conf 2>/dev/null && log "Tmux configuration reloaded" || warn "Could not reload tmux config"
fi

# Show what changed
echo ""
log "Key differences:"
if [[ "$CONFIG" == "minimal" ]]; then
    echo "  - No TPM (plugin manager)"
    echo "  - No plugins"
    echo "  - Hardcoded status bar"
    echo "  - Fast startup, zero dependencies"
    echo "  - Perfect for remote servers"
else
    echo "  - TPM plugin manager"
    echo "  - Theme-aware status bar"
    echo "  - Extended keybindings"
    echo "  - Full plugin suite"
fi
